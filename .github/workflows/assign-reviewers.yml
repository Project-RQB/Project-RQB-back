name: Assign Reviewers and Assignee

on:
  pull_request:
    types: [opened]

jobs:
  assign_reviewers_and_assignee:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: yarn add @octokit/rest

      - name: Assign Reviewers and Assignee
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          const { Octokit } = require("@octokit/rest");
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

          let MAIN_REVIEWERS = ['gorilla-muscle', 'topi0247'];
          let SUB_REVIEWERS = ['UNNNYO', 'UNNNYO', 'miura-taiga'];

          const prAuthor = process.env.PR_AUTHOR;

          // プルリクを出したユーザーをレビュワーリストから削除
          MAIN_REVIEWERS = MAIN_REVIEWERS.filter(user => user !== prAuthor);
          SUB_REVIEWERS = SUB_REVIEWERS.filter(user => user !== prAuthor);

          const getRandomReviewer = (reviewers) => {
            const randomIndex = Math.floor(Math.random() * reviewers.length);
            return reviewers[randomIndex];
          };

          const mainReviewer = getRandomReviewer(MAIN_REVIEWERS);
          const subReviewer = getRandomReviewer(SUB_REVIEWERS);

          const reviewers = [mainReviewer, subReviewer];

          (async () => {
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const pull_number = process.env.GITHUB_REF.split('/').pop();

            // レビュワーをアサイン
            await octokit.pulls.requestReviewers({
              owner,
              repo,
              pull_number,
              reviewers
            });

            // プルリクエストの作成者をアサイン
            await octokit.issues.addAssignees({
              owner,
              repo,
              issue_number: pull_number,
              assignees: [prAuthor]
            });
          })();
